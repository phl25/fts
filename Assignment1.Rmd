---
title: "Assignment 1"
author: "Philipp Epstein"
date: "10/14/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Blabla Blabla

# Trading Idea

Explain here the traiding idea, where I found it. What the theoretical foundation is --> Long Term positive autocorreleation
--> Short term negative autocorreleation

Trade reverse patterns. When observing a fallback, trade to profit from the upward trend after the fallback. etc....

## Implementation of the trading idea

Short paragraph about what is needed for the implementation

### Part A: Initialization

#### General Setup
```{r message=FALSE}
# Clear Environment
rm(list=ls())

# Loading libraries
library(blotter)
library(INFT361Course)
```

#### Setting the Variables
The variables set in the next section can be adjusted to test the strategy with different parameters. 

```{r message=FALSE, results="hide"}
# Set values:
startCapital <- 1e+6
transactionCost <- -20
daterange <- '2016::2018' 
emaPeriod <- 200
maxHoldingPeriod <- 30

InstrumentDirectory <- "~/Desktop/R/DownloadedData/"
instrument <- "SAP.csv"
BuyHoldDirectory <- InstrumentDirectory
BuyHoldInstrument <- instrument

currency("EUR")
Sys.setenv(TZ="UTC") 
initdate <- '1999-12-31'
startdate <- '2000-01-01' 
enddate <- '2018-12-31' 
portfolioname <- "Smash Day" 
accountname <- portfolioname
```


#### Initializing the portfolio

```{r message=FALSE, results="hide"}
# Clear portfolio and Account
suppressWarnings(rm("account.Smash Day","portfolio.Smash Day","account.buyhold","portfolio.buyhold",pos=.blotter))

# Initialize Portfolio and Account
initPortf(portfolioname,instrument,initDate=initdate,currency="EUR")
initAcct(accountname,portfolios=portfolioname,initDate=initdate,initEq=startCapital,currency="EUR")
```


### Part B: Bar by bar processing

Loading the instrument, initializing it and adding the ema to the data.
```{r message=FALSE, results="hide"}

LoadCourseFile(InstrumentDirectory, instrument, debugme = TRUE, dates = daterange)
  
  # Initialize the instrument
  stock(instrument, currency = "EUR")
  
  # Load the XTS file
  symbol <- get(instrument)
  
  # Calculate the Exponential Moving Average
  ema <- EMA(symbol$Close, n=emaPeriod)
  
  # Merge the xts file with the Exponential Moving Average
  symbol <- merge(symbol,ema)
```


Starting to go bar by bar through using a "for loop"

```{r message=FALSE, results="hide"}  
for (i in (emaPeriod + 1):(nrow(symbol) - 1)) {
  # Dates
  CurrentDate <- time(symbol[i])
  TomorrowDate <- time(symbol[i + 1])
  
  # Today's variables
  CloseToday <- as.numeric(symbol[i, "Close"])
  EMA_today <- as.numeric(symbol[i, "EMA"])
  LowToday <- as.numeric(symbol[i, "Low"])
  HighToday <- as.numeric(symbol[i, "High"])
  
  # Yesterday's variables
  LowYesterday <- as.numeric(symbol[i - 1, "Low"])
  HighYesterday <- as.numeric(symbol[i - 1, "High"])
  
  # Tomorrow's variables
  OpenTomorrow <- as.numeric(symbol[i + 1, "Open"])
  LowTomorrow <- as.numeric(symbol[i + 1, "Low"])
  HighTomorrow <- as.numeric(symbol[i + 1, "High"])
  
  # Config
  Equity <- getEndEq(accountname, CurrentDate)
  Position <-
    getPosQty(portfolioname, Symbol = instrument, Date = CurrentDate)
  
  # Check whether we have a position
  if (Position == 0) {
    # Start checking BUY rules
    
    # Check whether we have a Smash Day (Long).
    # Smash Day (Long) is when Todays Close is below Yesterdays Low.
    if (CloseToday < LowYesterday) {
      # Smash Day (Long)
      
      #Check whether todays close is above today's EMA
      if (CloseToday > EMA_today) {
        
        # BUY RULE: If today was a smash day place a STOP BUY order at todays high price. 
        # (Buy tomorrow for 'price >= todays high')
        
        # Simulate STOP BUY order:
        
        # Option 1 to check: Check whether the open price tomorrow is above today's high 
        # and add the transaction tomorrow at tomorrows open price.
        
        # Option 2 to check: Check whether today's high was lower than tomorrows high 
        # and add the transaction tomorrow at today's high price.
        
        # Check Option 1
        if (OpenTomorrow > HighToday) {
          # Don't trade at the day before the last day
          if (CurrentDate != time(symbol[nrow(symbol) - 1])) {
            # Calculate the buy quantity
            BuyQuantity <- as.numeric(trunc(Equity / OpenTomorrow))
            # Add transaction
            addTxn(
              portfolioname,
              Symbol = instrument,
              TxnDate = TomorrowDate ,
              TxnPrice = OpenTomorrow,
              TxnQty = BuyQuantity,
              TxnFees = transactionCost
            )
            # Store the bar at which we placed the transaction
            BuyBar <- i
          }
          
        } else {
          # Check Option 2
          if (HighToday < HighTomorrow) {
            # Don't trade at the day before the last day
            if (CurrentDate != time(symbol[nrow(symbol) - 1])) {
              # Calculate the buy quantity
              BuyQuantity <- as.numeric(trunc(Equity / HighToday))
              # Add transaction
              addTxn(
                portfolioname,
                Symbol = instrument,
                TxnDate = TomorrowDate ,
                TxnPrice = HighToday,
                TxnQty = BuyQuantity,
                TxnFees = transactionCost
              )
              # Store the bar at which we placed the transaction
              BuyBar <- i
            }
          }
        }
      }
    }
  } else {
    # We already have a position
    
    # Check the sell rules in the following order and sell at the 
    # first condition which is satisfied.
    
    # Sell rules:
    # Rule 1: Sell if we hold the position longer than the specified 
    # maximum holding period
    
    # Rule 2: Sell at tomorrow's opening price if the close price 
    # today falls below the EMA
    
    # Rule 3: Sell if we meet the Smash Day (Short) requirements. 
    # Today's close must be higher than yesterday's high
    
    # Rule 4: If no sell rule can be applied and we reach the 
    # second last day. Sell at the last day.
    
    # Check Rule 1:
    if ((i - BuyBar) > maxHoldingPeriod) {
      # Place the sell transaction at todays close price
      addTxn(
        portfolioname,
        Symbol = instrument,
        TxnDate = CurrentDate,
        TxnPrice = as.numeric(symbol[i, "Close"]),
        TxnQty = -Position,
        TxnFees = transactionCost
      )
      
    } else {
      # Check Rule 2:
      if (as.numeric(symbol[i, "Close"]) < EMA_today) {
        # Place the sell transaction at tomorrow's open price
        addTxn(
          portfolioname,
          Symbol = instrument,
          TxnDate = time(symbol[i + 1]),
          TxnPrice = OpenTomorrow,
          TxnQty = -Position,
          TxnFees = transactionCost
        )
        
      } else {
        # Check Rule 3:
        
        # Sell Rule 3: If today was a smash day (short) place an order at todays 
        # low price. (Buy tomorrow for 'price <= todays low')
        
        # Simulate this behaviour:
        
        # Option 1 to check: Check whether the open price tomorrow is below today's 
        # low and add the transaction tomorrow at tomorrows open price.
        
        # Option 2 to check: Check whether today's low was larger than tomorrow's 
        # low and add the transaction tomorrow at today's low price.
        
        # Check for Smash Day (Short)
        if (CloseToday > HighYesterday) {
          # Check for Option 1
          if (OpenTomorrow < LowToday) {
            # Add Sell transaction tomorrow at tomorrow's open price
            addTxn(
              portfolioname,
              Symbol = instrument,
              TxnDate = time(symbol[i + 1]),
              TxnPrice = OpenTomorrow,
              TxnQty = -Position,
              TxnFees = transactionCost
            )
            
          } else {
            # Check for Option 2
            if (LowToday > LowTomorrow) {
              # Add Sell transaction tomorrow at today's low price
              addTxn(
                portfolioname,
                Symbol = instrument,
                TxnDate = time(symbol[i + 1]),
                TxnPrice = LowToday,
                TxnQty = -Position,
                TxnFees = transactionCost
              )
            }
          }
        } else {
          # Check Rule 4
          if (i == nrow(symbol) - 1) {
            # Add Sell transaction for the last day at the close price
            addTxn(
              portfolioname,
              Symbol = instrument,
              TxnDate = time(symbol[i + 1]),
              TxnPrice = as.numeric(symbol[i, "Close"]),
              TxnQty = -Position,
              TxnFees = transactionCost
            )
          }
        }
      }
    }
  }
  
  updatePortf(portfolioname, Symbols = instrument, Dates = CurrentDate)
  updateAcct(accountname, Dates = CurrentDate)
  updateEndEq(accountname, CurrentDate)
  
} # End Bar-by-bar processing

```



### Part C: Analysis and Reporting
```{r message=FALSE, echo=FALSE}  
# Settings for graph
myTheme <- chart_theme()
myTheme$col$up.col <- 'lightblue'
myTheme$col$dn.col <- 'brown'
myTheme$col$dn.border <- 'lightgray'
myTheme$col$up.border <- 'lightgray'

# Concatenate string for EMA with input parameter
addEMAString <- paste("add_EMA(n=",emaPeriod,")",sep = "")

```

#### Visualize original data
Plot of the `r instrument` instrument with the EMA line which indicates the general trend of the stock exponentially smoothed for the last 200 days. Moreover, the tradevolume is added below the graph.
```{r message=FALSE, echo=FALSE}
chart_Series(x=symbol,name=instrument,theme=myTheme, subset=daterange,TA="add_TA((symbol$EMA), on=1,type='l',col='blue');add_Vo()")
```


#### All transactions performed by the trading system
The following table can be used to get a better overview of the transactions performed and the exact details per transaction. 
```{r message=FALSE, echo=FALSE}
getTxns(Portfolio=portfolioname,Symbol=instrument)
```

#### Graph which visualize the transactions
The following graph shows the combined view of the performance of the Smash Day trading system. It visualizes the trades (buy-transactions are visualized in green and sell-transactions are visualized in red). Moreover, the size of the blue squares indicates the size of the position (height) and the holding duration of the position (width). The green line shows the cummulative net profit curve, while the red curve indicates the drawdown on each day compared to the last reached high.
```{r message=FALSE, echo=FALSE}
# Plot graph with indicators for transaction 
chart.Posn(portfolioname,Symbol=instrument,type='candlesticks', theme=myTheme,subset=daterange,TA=addEMAString)
```

#### Performance Statistics
The following table summarizes some important trading statistics
```{r message=FALSE, echo=FALSE, results="hide"}
tstats <- tradeStats(Portfolio=portfolioname)
trades.tab <- cbind(
  c("Trades", "Win Percent", "Loss Percent","W/L Ratio"),
  c(tstats[,"Num.Trades"],tstats[,"Percent.Positive"],tstats[,"Percent.Negative"],tstats[,"Percent.Positive"]/tstats[,"Percent.Negative"]))
```

```{r message=FALSE, echo=FALSE}
trades.tab
```

#### Visualize returns of the trading strategy

```{r message=FALSE, results="hide"}
library(PerformanceAnalytics) # contains lots of methods to investigate performance
# obtain the portfolio returns - with these you can compute virtually any financial metrics you wish
rets <- PortfReturns(Account=accountname) 
rownames(rets) <- NULL # this step is important!
```

```{r message=FALSE}
charts.PerformanceSummary(rets,colorset=bluefocus)
```

#### Calculate statistics of the Portfolio
```{r message=FALSE, results="hide"}
tab.perf <- table.Arbitrary(rets, metrics=c("Return.cumulative", "Return.annualized","SharpeRatio.annualized","CalmarRatio"),
                            metricsNames=c("Cumulative Return", "Annualized Return", "Annualized Sharp Ratio","Calmar Ratio"))
tab.risk <- table.Arbitrary(rets, metrics=c("StdDev.annualized", "maxDrawdown","VaR","ES"),
                            metricsNames=c("Annualized StdDev", "Max Drawdown", "Value-at-Risk","Conditional VaR"))
# present the portfolio statistics
somestats <- data.frame(rownames(tab.perf),tab.perf[,1], rownames(tab.risk),tab.risk[,1])
colnames(somestats) <- c("Performance Metric", "Performance Value", "Risk Metric", "Risk Value")
```

```{r message=FALSE, echo=FALSE}
somestats
```


### Compare with Buy and Hold Strategy
In order to compare the trading strategy properly we need to define a benchmark against which we can measure the results. In this case a simple buy and hold strategy is used. At the first date of the trading period we place a buy order and sell our position at the last day of the selected period.
In order to do this we create a new Portfolio and a new Account.

```{r message=FALSE, results="hide"}
  # We remove any objects, in case there was a buyhold portfolio initialized before
  suppressWarnings(try(rm(list=c("account.buyhold","portfolio.buyhold"),pos=.blotter)))
  
  # The Buy and hold symbol is loaded 
  LoadCourseFile(BuyHoldDirectory,BuyHoldInstrument,debugme=TRUE,dates=daterange)
  # The Buy and hold instrument is initialized
  stock(BuyHoldInstrument,currency="EUR")
  
  BuyHoldSymbol<-get(BuyHoldInstrument)
  
  # The portfolio and account "buyhold" is initialized
  initPortf("buyhold",BuyHoldInstrument,initDate=initdate,currency="EUR")
  initAcct("buyhold",portfolios="buyhold",initDate=initdate,initEq=startCapital,currency="EUR")
  
  # The first date of the defined daterange is selected
  currentdate <- first(time(BuyHoldSymbol))
  
  # The close price at this date is selected
  closeprice <- as.numeric(Cl(BuyHoldSymbol[currentdate,]))
  
  # Calculate the unitsize we can buy with our startingcapital
  unitsize <- as.numeric(trunc(startCapital/closeprice))
  
  # Place the transaction for the instrument at the first date
  addTxn("buyhold",Symbol=BuyHoldInstrument,TxnDate=currentdate,TxnPrice=closeprice,TxnQty=unitsize,TxnFees=transactionCost)
  
  # Select the last date of the daterange period
  lastdate <-last(time(BuyHoldSymbol))
  
  # Select the price at the last date
  lastprice <- as.numeric(Cl(BuyHoldSymbol[lastdate,]))
  
  # Sell the position at the last date of the daterange
  addTxn("buyhold",Symbol=BuyHoldInstrument,TxnDate=lastdate,TxnPrice=lastprice,TxnQty=-unitsize,TxnFees=transactionCost)
  
  # update portfolio and account
  updatePortf(Portfolio="buyhold")
  updateAcct(name="buyhold")
  updateEndEq(Account="buyhold")
```  
  
#### Visualize the Buy and Hold strategy
  We can see that we hold the position from the first until the last date. The cumulative profits are visualized by the green line.
```{r message=FALSE}
  chart.Posn("buyhold",Symbol=BuyHoldInstrument, theme=myTheme)
```

### Compare the returns of the trading strategy with the buy and hold strategy
In order to compare the results of both strategies we calculat the returns for the buy and hold strategy and combine them with the returns of the trading strategy which were calculatet before.
```{r message=FALSE, results="hide"}
rets.bh <- PortfReturns(Account='buyhold')
returns <- cbind(rets,rets.bh)
rulecol <- paste(portfolioname,instrument,sep="-")
colnames(returns) <- c(rulecol,"Buy-and-hold")
```

We compare the two strategies by showing some statistical metrics of the returns and plot the returns in one chart to directly compare the performance of the strategies.
```{r message=FALSE}
table.Stats(returns)
table.AnnualizedReturns(returns)
charts.PerformanceSummary(returns,geometric=FALSE,wealth.index=TRUE)
chart.RiskReturnScatter(returns,Rf=0,add.sharpe=c(1,2),xlim=c(0,0.25),main="Return versus Risk",colorset = c("red","blue"))
chart.RelativePerformance(returns[,1],returns[,2],colorset=c("red","blue"),lwd=2,legend.loc="topleft")
```

## Backtest

### Approach

### Implementation

### System Check

To make sure that our system worked properly some transactions were observed to make sure that the trades were performed according to the defined rules. Prepare the chart. Check 3 transactions.
```{r message=FALSE, results="hide", warning=FALSE}
rm(daterange_check)
daterange_check <- c()
transactionsInstrument <- getTxns(Portfolio=portfolioname,Symbol=instrument)
for (i in c(2,4, (nrow(transactionsInstrument)-7), (nrow(transactionsInstrument)-5))) {
  from <- as.Date(index(transactionsInstrument[i,1]))-7
  to <- as.Date(index(transactionsInstrument[i+1,1]))+7
  daterange_check <- c(daterange_check, paste(from, "::", to, sep = ""))
}
```

Visualize the charts with the transactions which should be checked
```{r message=FALSE}
for (daterange_check_i in daterange_check){
  chart.Posn(portfolioname,Symbol=instrument,type='candlesticks', theme=myTheme,subset=daterange_check_i,TA=addEMAString)
}
```


### Analysis

### Returns

#### Historical VaR

#### Equity curve

# Conclusion and Suggestions
